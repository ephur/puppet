#!/bin/sh

echodo()
{
    echo "${@}"
    (${@})
}

yearmon()
{
    date '+%Y%m%d'
}

fqdn()
{
    (nslookup ${1} 2>&1 || echo Name ${1}) \
        | tail -3 | grep Name| sed -e 's,.*e:[ \t]*,,'
}

C=<%= @cert_country %>
ST=<%= @cert_state %>
L=<%= @cert_location %>
O=<%= @cert_org %>
OU<%= @cert_orgunit %>
CN<%= @name %>
DATE=`yearmon`

HOST=${1:-`hostname`}
CSR="/etc/apache2/ssl/<%= @name %>.csr"
KEY="/etc/apache2/ssl/<%= @name %>.key"
CERT="/etc/apache2/ssl/<%= @name %>.cert"

# Create the certificate signing request
openssl req -new -passin pass:password -passout pass:password -out $CSR <<EOF
${C}
${ST}
${L}
${O}
${OU}
${CN}
$USER@${CN}
.
.
EOF
echo ""

[ -f ${CSR} ] && echodo openssl req -text -noout -in ${CSR}
echo ""

# Create the Key
openssl rsa -in privkey.pem -passin pass:password -passout pass:password -out ${KEY}

# Create the Certificate
openssl x509 -in ${CSR} -out ${CERT} -req -signkey ${KEY} -days 1000

chmod 644 $CSR
chmod 600 $KEY
chmod 644 $CERT